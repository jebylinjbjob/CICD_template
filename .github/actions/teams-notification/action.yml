name: 'Teams é€šçŸ¥'
description: 'ç™¼é€ CI/CD çµæœé€šçŸ¥åˆ° Microsoft Teams'
author: 'PortalApi Team'

inputs:
  webhook_url:
    description: 'Microsoft Teams Webhook URL'
    required: true
  workflow_name:
    description: 'å·¥ä½œæµç¨‹åç¨±'
    required: true
  status:
    description: 'åŸ·è¡Œç‹€æ…‹ (success/failure/cancelled)'
    required: true
  title:
    description: 'é€šçŸ¥æ¨™é¡Œ'
    required: false
    default: ''
  extra_info:
    description: 'é¡å¤–è³‡è¨Šï¼ˆé¸å¡«ï¼‰'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: æº–å‚™é€šçŸ¥å…§å®¹
      id: prepare
      shell: pwsh
      run: |
        # æ ¹æ“šç‹€æ…‹è¨­å®šé¡è‰²å’Œåœ–ç¤º
        $status = "${{ inputs.status }}"
        $color = switch ($status) {
          "success" { "00FF00"; break }
          "failure" { "FF0000"; break }
          "cancelled" { "FFA500"; break }
          default { "808080" }
        }

        $icon = switch ($status) {
          "success" { "âœ…"; break }
          "failure" { "âŒ"; break }
          "cancelled" { "âš ï¸"; break }
          default { "â„¹ï¸" }
        }

        $statusText = switch ($status) {
          "success" { "æˆåŠŸ"; break }
          "failure" { "å¤±æ•—"; break }
          "cancelled" { "å·²å–æ¶ˆ"; break }
          default { $status }
        }

        echo "color=$color" >> $env:GITHUB_OUTPUT
        echo "icon=$icon" >> $env:GITHUB_OUTPUT
        echo "status_text=$statusText" >> $env:GITHUB_OUTPUT

    - name: ç™¼é€ Teams é€šçŸ¥
      shell: pwsh
      run: |
        $webhookUrl = "${{ inputs.webhook_url }}"
        $extraInfo = "${{ inputs.extra_info }}"
        $customTitle = "${{ inputs.title }}"
        $commitMessage = "${{ github.event.head_commit.message }}"

        # å¦‚æœæ²’æœ‰è‡ªå®šç¾©æ¨™é¡Œï¼Œä½¿ç”¨ commit è¨Šæ¯ä½œç‚ºæ¨™é¡Œ
        if (-not $customTitle) {
          $customTitle = $commitMessage
        }

        # å»ºç«‹ç¾åŒ–çš„è¨Šæ¯å…§å®¹
        $facts = @(
          @{
            "name" = "ğŸ”„ å·¥ä½œæµç¨‹"
            "value" = "${{ inputs.workflow_name }}"
          },
          @{
            "name" = "ğŸ“Š ç‹€æ…‹"
            "value" = "${{ steps.prepare.outputs.icon }} ${{ steps.prepare.outputs.status_text }}"
          },
          @{
            "name" = "ğŸŒ¿ åˆ†æ”¯"
            "value" = "${{ github.ref_name }}"
          },
          @{
            "name" = "ğŸ‘¤ è§¸ç™¼è€…"
            "value" = "${{ github.actor }}"
          },
          @{
            "name" = "ğŸ“ æäº¤è¨Šæ¯"
            "value" = $commitMessage
          },
          @{
            "name" = "â° åŸ·è¡Œæ™‚é–“"
            "value" = "$([System.TimeZoneInfo]::ConvertTimeBySystemTimeZoneId((Get-Date), 'Taipei Standard Time').ToString('yyyy-MM-dd HH:mm:ss'))"
          }
        )

        if ($extraInfo) {
          $facts += @{
            "name" = "â„¹ï¸ é¡å¤–è³‡è¨Š"
            "value" = $extraInfo
          }
        }

        # å»ºç«‹ Teams è¨Šæ¯å¡ç‰‡
        $body = @{
          "@type" = "MessageCard"
          "@context" = "https://schema.org/extensions"
          "themeColor" = "${{ steps.prepare.outputs.color }}"
          "title" = "${{ steps.prepare.outputs.icon }} $customTitle"
          "summary" = "${{ inputs.workflow_name }} - ${{ steps.prepare.outputs.status_text }}"
          "sections" = @(
            @{
              "activityTitle" = "ğŸ“¦ ${{ github.repository }}"
              "activitySubtitle" = "GitHub Actions è‡ªå‹•åŒ–é€šçŸ¥"
              "facts" = $facts
            }
          )
          "potentialAction" = @(
            @{
              "@type" = "OpenUri"
              "name" = "ğŸ”— æŸ¥çœ‹åŸ·è¡Œè©³æƒ…"
              "targets" = @(
                @{
                  "os" = "default"
                  "uri" = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }
              )
            }
          )
        } | ConvertTo-Json -Depth 10

        # ç™¼é€åˆ° Teams
        try {
          $response = Invoke-RestMethod -Uri $webhookUrl -Method Post -Body $body -ContentType 'application/json; charset=utf-8'
          Write-Host "âœ… Teams é€šçŸ¥ç™¼é€æˆåŠŸ" -ForegroundColor Green
        } catch {
          Write-Host "âŒ Teams é€šçŸ¥ç™¼é€å¤±æ•—: $_" -ForegroundColor Red
          Write-Host "Webhook URL (å‰10å­—å…ƒ): $($webhookUrl.Substring(0, [Math]::Min(10, $webhookUrl.Length)))..." -ForegroundColor Yellow
          exit 1
        }
