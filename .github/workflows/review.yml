# Pull Request è‡ªå‹•åŒ–æª¢æŸ¥å’Œå¯©æŸ¥å·¥ä½œæµç¨‹
# ç•¶å»ºç«‹æˆ–æ›´æ–° PR æ™‚è‡ªå‹•åŸ·è¡Œç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
name: PR Review & Quality Check

# è§¸ç™¼æ¢ä»¶ - é‡å°æ‰€æœ‰åˆ†æ”¯çš„ Pull Request
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
      - develop
      - 'feature/**'
      - 'hotfix/**'
      - 'release/**'

# å…¨åŸŸç’°å¢ƒè®Šæ•¸
env:
  DOTNET_VERSION: '8.0.x'
  BUILD_CONFIGURATION: 'Release'
  SOLUTION_PATH: 'PortalApi.sln'


# ä½µç™¼æ§åˆ¶ - å–æ¶ˆåŒä¸€ PR çš„èˆŠç‰ˆåŸ·è¡Œ
concurrency:
  group: pr-${{ github.event.number }}
  cancel-in-progress: true

jobs:
  # === ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥ ===
  code-quality:
    name: 'ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥'
    runs-on: windows-latest
    # è·³éè‰ç¨¿ PR é™¤éæ˜ç¢ºæ¨™è¨˜
    if: github.event.pull_request.draft == false

    steps:
      # æ­¥é©Ÿ 1: æª¢å‡º PR ç¨‹å¼ç¢¼
      - name: Checkout PR code
        uses: actions/checkout@v5
        with:
          # æª¢å‡º PR çš„ HEADï¼ŒåŒ…å«å®Œæ•´æ­·å²è¨˜éŒ„ç”¨æ–¼æ¯”è¼ƒ
          fetch-depth: 0

      # æ­¥é©Ÿ 2: è¨­å®š .NET ç’°å¢ƒ
      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # æ­¥é©Ÿ 3: å¿«å– NuGet å¥—ä»¶
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # æ­¥é©Ÿ 4: é‚„åŸ NuGet ç›¸ä¾æ€§
      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_PATH }}
        shell: powershell

      # æ­¥é©Ÿ 5: å»ºç½®å°ˆæ¡ˆ
      - name: Build solution
        run: |
          Write-Host "=== å»ºç½®æ–¹æ¡ˆ ===" -ForegroundColor Green
          dotnet build ${{ env.SOLUTION_PATH }} --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore
        shell: powershell

      # æ­¥é©Ÿ 6: æª¢æŸ¥ NuGet å¥—ä»¶æˆæ¬Š
      - name: Check NuGet package licenses
        uses: jwaliszko/nuget-license-sentinel@v1
        with:
          solution-path: ${{ env.SOLUTION_PATH }}
          allowed-licenses: 'MIT,Apache-2.0,BSD-3-Clause,ISC,BSD-2-Clause,MS-PL,CC0-1.0'
          fail-on-forbidden: true
          output-file: 'license-report.json'
          include-project-dependencies: true


  # === PR ç‹€æ…‹å’Œè©•è«– ===
  pr-feedback:
    name: 'PR å›é¥‹'
    permissions:
      issues: write # ç™¼å¸ƒç•™è¨€åˆ° PR
      contents: read # è®€å–ç¨‹å¼ç¢¼
      pull-requests: write # å¯«å…¥ PR
      actions: read # è®€å– Actions

    runs-on: windows-latest
    needs: code-quality
    if: always() && github.event.pull_request.draft == false

    steps:
      # æª¢å‡ºç¨‹å¼ç¢¼ä»¥ä½¿ç”¨æœ¬åœ° action
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download test results
        uses: actions/download-artifact@v6
        with:
          name: test-results
          path: test-results
        continue-on-error: true

      - name: Generate PR comment
        uses: actions/github-script@v8
        with:
          script: |

            const codeQualityResult = process.env.CODE_QUALITY_RESULT ?? '${{ needs.code-quality.result }}';
            let cqStatus = codeQualityResult;

            // å»ºç«‹ç‹€æ…‹å ±å‘Š
            let comment = `## ğŸ” PR è‡ªå‹•æª¢æŸ¥å ±å‘Š\n\n`;
            comment += `**æª¢æŸ¥æ™‚é–“**: ${(new Date()).toLocaleString('zh-TW')}\n`;
            comment += `**PR**: #${{ github.event.number }} - ${{ github.event.pull_request.title }}\n`;
            comment += `**åˆ†æ”¯**: \`${{ github.head_ref }}\` â†’ \`${{ github.base_ref }}\`\n\n`;

            comment += `### ğŸ“Š æª¢æŸ¥çµæœ\n\n`;
            comment += `| æª¢æŸ¥é …ç›® | ç‹€æ…‹ |\n`;
            comment += `|---------|-----|\n`;
            comment += `| ğŸ—ï¸ ç¨‹å¼ç¢¼å“è³ª | ${cqStatus === 'success' ? 'âœ… é€šé' : 'âŒ å¤±æ•—'} |\n`;

            // å¯æ“´å……å¦‚æœ‰ unitTestResult/securityResult éœ€è¦

            if (cqStatus !== 'success') {
              comment += `\n### âš ï¸ éœ€è¦æ³¨æ„çš„å•é¡Œ\n\n`;
              comment += `- ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å»ºç½®éŒ¯èª¤æˆ–æ ¼å¼å•é¡Œ\n`;
              comment += `\nè«‹ä¿®æ­£ä¸Šè¿°å•é¡Œå¾Œé‡æ–°æ¨é€ç¨‹å¼ç¢¼ã€‚\n`;
            } else {
              comment += `\n### âœ… æ‰€æœ‰æª¢æŸ¥é€šé\n\n`;
              comment += `æ­å–œï¼æ‚¨çš„ PR å·²é€šéæ‰€æœ‰è‡ªå‹•æª¢æŸ¥ï¼Œå¯ä»¥é€²è¡Œç¨‹å¼ç¢¼å¯©æŸ¥ã€‚\n`;
            }
            // ç™¼å¸ƒç•™è¨€åˆ° PR
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment,
            });
        #ä»¥å…æ¬Šé™ä¸å¤ å°è‡´å¤±æ•—
        continue-on-error: true

      # ç™¼é€ Teams é€šçŸ¥
      - name: Notify Teams
        if: always()
        uses: ./.github/actions/teams-notification
        with:
          webhook_url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          workflow_name: ${{ github.workflow }}
          status: ${{ needs.code-quality.result }}
          title: 'PortalApi PR #${{ github.event.number }} å¯©æŸ¥å®Œæˆ'
          extra_info: |
            **PR æ¨™é¡Œ**: ${{ github.event.pull_request.title }}
            **åˆ†æ”¯**: ${{ github.head_ref }} â†’ ${{ github.base_ref }}
            **ç¨‹å¼ç¢¼å“è³ª**: ${{ needs.code-quality.result == 'success' && 'âœ… é€šé' || 'âŒ å¤±æ•—' }}
            **PR é€£çµ**: ${{ github.event.pull_request.html_url }}
        continue-on-error: true
